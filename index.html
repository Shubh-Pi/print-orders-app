<!DOCTYPE html>
<html>
<head>
  <title>Client Portal - Print Orders</title>
  <meta charset="UTF-8">
  <style>
    /* Simple styling to hide sections */
    #orderSection, #registrationSection, #recoverySection {
      display: none;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Client Portal</h1>
  
  <!-- Login Form -->
  <div id="loginSection">
    <h2>Login</h2>
    <form id="loginForm">
      <label for="loginEmail">Email:</label>
      <input type="email" id="loginEmail" name="loginEmail" placeholder="your-email@domain.com" required><br><br>
      <label for="loginPassword">Password:</label>
      <input type="password" id="loginPassword" name="loginPassword" required><br><br>
      <button type="submit">Login</button>
    </form>
    <p>
      Not registered? <a href="#" id="showRegister">Register here</a>.
    </p>
    <p>
      Forgot password? <a href="#" id="showRecovery">Recover account</a>.
    </p>
  </div>
  
  <!-- Registration Form -->
  <div id="registrationSection">
    <h2>Register</h2>
    <form id="registerForm">
      <label for="regEmail">Email:</label>
      <input type="email" id="regEmail" name="regEmail" placeholder="your-email@domain.com" required><br><br>
      <label for="regPassword">Password:</label>
      <input type="password" id="regPassword" name="regPassword" required><br><br>
      <button type="submit">Register</button>
    </form>
    <p>
      Already have an account? <a href="#" id="showLoginFromReg">Login here</a>.
    </p>
  </div>
  
  <!-- Account Recovery Form -->
  <div id="recoverySection">
    <h2>Account Recovery</h2>
    <form id="recoveryRequestForm">
      <label for="recoverEmail">Email:</label>
      <input type="email" id="recoverEmail" name="recoverEmail" placeholder="your-email@domain.com" required><br><br>
      <button type="submit">Send Recovery Code</button>
    </form>
    <br>
    <form id="recoveryVerifyForm">
      <label for="recoverCode">Recovery Code:</label>
      <input type="text" id="recoverCode" name="recoverCode" required><br><br>
      <label for="newPassword">New Password:</label>
      <input type="password" id="newPassword" name="newPassword" required><br><br>
      <button type="submit">Reset Password</button>
    </form>
    <p>
      Back to <a href="#" id="showLoginFromRec">Login</a>.
    </p>
  </div>
  
  <!-- Order Form Section -->
  <div id="orderSection">
    <h2>Place Your Print Order</h2>
    <form id="orderForm">
      <label for="subject">Subject:</label>
      <select id="subject" name="subject"></select><br><br>

      <label for="output">Output:</label>
      <select id="output" name="output"></select><br><br>

      <label for="quantity">Quantity:</label>
      <input type="number" id="quantity" name="quantity" value="1" min="1"><br><br>

      <label for="rubric">Rubric Required:</label>
      <input type="checkbox" id="rubric" name="rubric"><br><br>

      <div id="rubricCountContainer" style="display: none;">
        <label for="rubricCount">No. of Rubrics Needed:</label>
        <input type="number" id="rubricCount" name="rubricCount" value="1" min="1"><br><br>
      </div>

      <div id="totalPayment">Total Payment: $0</div><br>

      <button type="submit">Submit Order</button>
    </form>
    <button id="logoutButton">Logout</button>
  </div>
  
  <script>
    // Update this URL to point to your Cloudflare Worker API endpoint.
    const API_URL = 'https://api.your-domain.workers.dev';
    
    // Utility: Show/hide sections.
    function showSection(sectionId) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('registrationSection').style.display = 'none';
      document.getElementById('recoverySection').style.display = 'none';
      document.getElementById('orderSection').style.display = 'none';
      document.getElementById(sectionId).style.display = 'block';
    }
    
    // On page load, check if client is logged in
    window.onload = () => {
      const token = localStorage.getItem('clientToken');
      if (token) {
        showSection('orderSection');
        loadSubjects();
      } else {
        showSection('loginSection');
      }
    };
    
    // --- Login Form ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const res = await fetch(API_URL + '/api/client/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const result = await res.json();
      if (result.success) {
        localStorage.setItem('clientToken', result.token);
        alert('Login successful!');
        showSection('orderSection');
        loadSubjects();
      } else {
        alert('Login failed: ' + result.error);
      }
    });
    
    // --- Registration Form ---
    document.getElementById('clientRegistrationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log("Register button clicked");
      
      const email = document.getElementById('clientEmail').value;
      const password = document.getElementById('clientPassword').value;
      console.log("Email:", email, "Password:", password);
      
      try {
        const response = await fetch(API_URL + '/api/client/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const result = await response.json();
        console.log("API Response:", result);
        if(result.success) {
          alert("Registration successful!");
        } else {
          alert("Registration failed: " + (result.error || "Unknown error"));
        }
      } catch (error) {
        console.error("Error during registration:", error);
        alert("Registration error: " + error.message);
      }
    });
    
    // --- Account Recovery: Request Recovery Code ---
    document.getElementById('recoveryRequestForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('recoverEmail').value;
      const res = await fetch(API_URL + '/api/client/recover/request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const result = await res.json();
      if (result.success) {
        alert(result.message);
      } else {
        alert('Recovery request failed: ' + result.error);
      }
    });
    
    // --- Account Recovery: Verify Code and Reset Password ---
    document.getElementById('recoveryVerifyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('recoverEmail').value;
      const code = document.getElementById('recoverCode').value;
      const newPassword = document.getElementById('newPassword').value;
      const res = await fetch(API_URL + '/api/client/recover/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, code, newPassword })
      });
      const result = await res.json();
      if (result.success) {
        alert('Password reset successful. Please login with your new password.');
        showSection('loginSection');
      } else {
        alert('Recovery verification failed: ' + result.error);
      }
    });
    
    // Navigation links
    document.getElementById('showRegister').addEventListener('click', () => {
      showSection('registrationSection');
    });
    document.getElementById('showLoginFromReg').addEventListener('click', () => {
      showSection('loginSection');
    });
    document.getElementById('showRecovery').addEventListener('click', () => {
      showSection('recoverySection');
    });
    document.getElementById('showLoginFromRec').addEventListener('click', () => {
      showSection('loginSection');
    });
    
    // Logout button
    document.getElementById('logoutButton').addEventListener('click', () => {
      localStorage.removeItem('clientToken');
      alert('Logged out successfully.');
      showSection('loginSection');
    });
    
    // --- Order Form Functions ---
    
    // Load available subjects from the API
    async function loadSubjects() {
      const res = await fetch(API_URL + '/api/subjects');
      const subjects = await res.json();
      const subjectSelect = document.getElementById('subject');
      subjectSelect.innerHTML = '';
      subjects.forEach(s => {
        const option = document.createElement('option');
        option.value = s;
        option.textContent = s;
        subjectSelect.appendChild(option);
      });
      loadOutputs(subjectSelect.value);
    }
    
    // Load outputs for the selected subject
    async function loadOutputs(subject) {
      const res = await fetch(API_URL + '/api/outputs?subject=' + encodeURIComponent(subject));
      const outputs = await res.json();
      const outputSelect = document.getElementById('output');
      outputSelect.innerHTML = '';
      outputs.forEach(o => {
        const option = document.createElement('option');
        option.value = o.id;
        option.textContent = o.name + ' ($' + o.price + ')';
        option.dataset.price = o.price;
        option.disabled = !o.available;
        outputSelect.appendChild(option);
      });
      calculatePayment();
    }
    
    // Calculate and display total payment (if needed)
    function calculatePayment() {
      const outputSelect = document.getElementById('output');
      const selectedOption = outputSelect.options[outputSelect.selectedIndex];
      const price = parseFloat(selectedOption.dataset.price || '0');
      const quantity = parseInt(document.getElementById('quantity').value || '1');
      const total = price * quantity;
      document.getElementById('totalPayment').textContent = 'Total Payment: $' + total.toFixed(2);
    }
    
    // Toggle rubric count field when rubric checkbox is changed
    document.getElementById('rubric').addEventListener('change', (e) => {
      const rubricCountContainer = document.getElementById('rubricCountContainer');
      rubricCountContainer.style.display = e.target.checked ? 'block' : 'none';
    });
    
    // Submit order, including client token in the header
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = localStorage.getItem('clientToken');
      if (!token) {
        alert('You must be logged in to place an order.');
        return;
      }
      const order = {
        subject: document.getElementById('subject').value,
        output: document.getElementById('output').value,
        quantity: parseInt(document.getElementById('quantity').value),
        rubric: document.getElementById('rubric').checked,
        rubricCount: document.getElementById('rubric').checked 
                        ? parseInt(document.getElementById('rubricCount').value)
                        : 0
      };
      const res = await fetch(API_URL + '/api/order', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(order)
      });
      const result = await res.json();
      if (result.success) {
        alert('Order placed successfully. Order ID: ' + result.orderId);
      } else {
        alert('Error placing order: ' + result.error);
      }
    });
  </script>
</body>
</html>
