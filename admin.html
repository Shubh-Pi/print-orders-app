<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Portal - Print Orders</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Admin Portal</h1>
  </header>
  <div class="container">
    <!-- Registration Section (shown if no admin registered) -->
    <section id="adminRegistrationSection" class="hidden">
      <h2>Admin Registration</h2>
      <form id="adminRegistrationForm">
        <label for="regAdminEmail">Email (must end with @nhitm.ac.in):</label>
        <input type="email" id="regAdminEmail" required placeholder="admin@nhitm.ac.in">
        <label for="regAdminPassword">Password:</label>
        <input type="password" id="regAdminPassword" required>
        <button type="submit">Register Admin</button>
      </form>
      <p id="registrationMessage"></p>
      <p>Already registered? <a href="#" id="switchToLogin">Login here</a></p>
    </section>

    <!-- Login Section -->
    <section id="adminLoginSection">
      <h2>Admin Login</h2>
      <form id="adminLoginForm">
        <label for="adminEmail">Email (must end with @nhitm.ac.in):</label>
        <input type="email" id="adminEmail" required placeholder="admin@nhitm.ac.in">
        <label for="adminPassword">Password:</label>
        <input type="password" id="adminPassword" required>
        <button type="submit">Login</button>
      </form>
      <p id="loginMessage"></p>
      <p>Not registered? <a href="#" id="switchToRegister">Register here</a></p>
    </section>

    <!-- Dashboard Section (hidden by default) -->
    <section id="dashboardSection" class="hidden">
      <nav>
        <button id="viewOrdersBtn">View Orders</button>
        <button id="editDataBtn">Edit Subjects & Outputs</button>
        <button id="logoutBtn">Logout</button>
      </nav>
      <!-- Orders View -->
      <div id="ordersView">
        <h2>Print Orders</h2>
        <div class="orders-container">
          <div>
            <h3>Pending Orders</h3>
            <table id="pendingOrdersTable">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Client Email</th>
                  <th>Subject</th>
                  <th>Output</th>
                  <th>Quantity</th>
                  <th>Rubric</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <h3>Completed Orders</h3>
            <table id="completedOrdersTable">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Client Email</th>
                  <th>Subject</th>
                  <th>Output</th>
                  <th>Quantity</th>
                  <th>Rubric</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Edit Data View -->
      <div id="editView" class="hidden">
        <h2>Edit Subjects & Outputs</h2>
        <div class="edit-form">
          <h3>Update Subjects</h3>
          <textarea id="subjectsInput" rows="3" placeholder='["Math", "Science", "History"]'></textarea>
          <button id="updateSubjectsBtn">Update Subjects</button>
        </div>
        <div class="edit-form">
          <h3>Update Outputs for a Subject</h3>
          <input type="text" id="subjectForOutputs" placeholder="Subject name">
          <textarea id="outputsInput" rows="5" placeholder='[{"id": "1", "name": "Output 1", "price": 10, "available": true}]'></textarea>
          <button id="updateOutputsBtn">Update Outputs</button>
        </div>
      </div>
      <p id="dashboardMessage"></p>
    </section>
  </div>

  <script>
    const API_URL = 'https://print-order-worker.balgudeshubham64.workers.dev';

    // Utility: Show or hide sections
    function showSection(sectionId) {
      // Hide all sections
      document.getElementById('adminRegistrationSection').classList.add('hidden');
      document.getElementById('adminLoginSection').classList.add('hidden');
      document.getElementById('dashboardSection').classList.add('hidden');
      // Show the requested section
      document.getElementById(sectionId).classList.remove('hidden');
    }

    // Check if admin is registered (this demo uses an API call)
    async function checkAdminRegistration() {
      try {
        // We'll try to get the admin credentials from the KV.
        // (Since there's no direct KV query here, you might add an API endpoint for this purpose.
        // For now, assume that if no token is stored in localStorage for admin, registration is needed.)
        const token = localStorage.getItem('adminToken');
        if (token) {
          showSection('dashboardSection');
          showDashboardView('ordersView');
          loadOrders();
        } else {
          // For demo, try to log in; if admin is not registered, show registration.
          // (You can adjust this logic as needed.)
          showSection('adminRegistrationSection');
        }
      } catch (error) {
        console.error("Error checking admin registration:", error);
        showSection('adminRegistrationSection');
      }
    }

    // Switch between registration and login forms
    document.getElementById('switchToLogin').addEventListener('click', function(e) {
      e.preventDefault();
      showSection('adminLoginSection');
    });
    document.getElementById('switchToRegister').addEventListener('click', function(e) {
      e.preventDefault();
      showSection('adminRegistrationSection');
    });

    // Admin Registration
    document.getElementById('adminRegistrationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('regAdminEmail').value;
      const password = document.getElementById('regAdminPassword').value;
      try {
        const res = await fetch(API_URL + '/api/admin/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const result = await res.json();
        const regMsg = document.getElementById('registrationMessage');
        if(result.success) {
          regMsg.textContent = result.message;
          regMsg.className = "message";
          setTimeout(() => showSection('adminLoginSection'), 1500);
        } else {
          regMsg.textContent = "Registration failed: " + (result.error || "Unknown error");
          regMsg.className = "error";
        }
      } catch (error) {
        document.getElementById('registrationMessage').textContent = "Registration error: " + error.message;
        document.getElementById('registrationMessage').className = "error";
      }
    });

    // Admin Login
    document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      try {
        const res = await fetch(API_URL + '/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const result = await res.json();
        const loginMsg = document.getElementById('loginMessage');
        if(result.success && result.token) {
          localStorage.setItem('adminToken', result.token);
          loginMsg.textContent = "Login successful!";
          loginMsg.className = "message";
          showSection('dashboardSection');
          showDashboardView('ordersView');
          loadOrders();
        } else {
          loginMsg.textContent = "Login failed: " + (result.error || "Invalid credentials");
          loginMsg.className = "error";
        }
      } catch (error) {
        document.getElementById('loginMessage').textContent = "Login error: " + error.message;
        document.getElementById('loginMessage').className = "error";
      }
    });

    // Admin Logout
    document.getElementById('logoutBtn').addEventListener('click', function(){
      localStorage.removeItem('adminToken');
      document.getElementById('adminEmail').value = "";
      document.getElementById('adminPassword').value = "";
      showSection('adminLoginSection');
    });

    // Navigation in dashboard
    document.getElementById('viewOrdersBtn').addEventListener('click', function(){
      showDashboardView('ordersView');
      loadOrders();
    });
    document.getElementById('editDataBtn').addEventListener('click', function(){
      showDashboardView('editView');
    });

    // Utility: Show a view within dashboard
    function showDashboardView(viewId) {
      document.getElementById('ordersView').classList.add('hidden');
      document.getElementById('editView').classList.add('hidden');
      if(viewId === 'ordersView'){
        document.getElementById('ordersView').classList.remove('hidden');
      } else if(viewId === 'editView'){
        document.getElementById('editView').classList.remove('hidden');
      }
    }

    // Load orders from the API (for admin)
    async function loadOrders() {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch(API_URL + '/api/orders', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const orders = await res.json();
        const pendingTbody = document.querySelector('#pendingOrdersTable tbody');
        const completedTbody = document.querySelector('#completedOrdersTable tbody');
        pendingTbody.innerHTML = "";
        completedTbody.innerHTML = "";
        orders.forEach(order => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${order.id}</td>
            <td>${order.email || 'N/A'}</td>
            <td>${order.subject}</td>
            <td>${order.output}</td>
            <td>${order.quantity}</td>
            <td>${order.rubric ? 'Yes' : 'No'}</td>
            <td>${order.paymentReceived ? '' : '<button onclick="markOrderPaid(\''+order.id+'\')">Mark as Paid</button>'}</td>
          `;
          if(order.paymentReceived) {
            completedTbody.appendChild(tr);
          } else {
            pendingTbody.appendChild(tr);
          }
        });
      } catch (error) {
        document.getElementById('dashboardMessage').textContent = "Error loading orders: " + error.message;
        document.getElementById('dashboardMessage').className = "error";
      }
    }

    // Mark order as paid
    async function markOrderPaid(orderId) {
      const token = localStorage.getItem('adminToken');
      try {
        const res = await fetch(API_URL + '/api/orders/' + orderId + '/markpaid', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });
        const result = await res.json();
        if(result.success) {
          loadOrders();
        } else {
          document.getElementById('dashboardMessage').textContent = "Error: " + result.error;
          document.getElementById('dashboardMessage').className = "error";
        }
      } catch (error) {
        document.getElementById('dashboardMessage').textContent = "Error marking order as paid: " + error.message;
        document.getElementById('dashboardMessage').className = "error";
      }
    }

    // Update subjects (edit view)
    document.getElementById('updateSubjectsBtn').addEventListener('click', async function(){
      const token = localStorage.getItem('adminToken');
      let subjectsText = document.getElementById('subjectsInput').value;
      try {
        const subjects = JSON.parse(subjectsText);
        const res = await fetch(API_URL + '/api/admin/subjects', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ subjects })
        });
        const result = await res.json();
        document.getElementById('dashboardMessage').textContent = result.success ? "Subjects updated successfully" : "Error: " + result.error;
        document.getElementById('dashboardMessage').className = result.success ? "message" : "error";
      } catch (e) {
        document.getElementById('dashboardMessage').textContent = "Invalid JSON for subjects";
        document.getElementById('dashboardMessage').className = "error";
      }
    });

    // Update outputs (edit view)
    document.getElementById('updateOutputsBtn').addEventListener('click', async function(){
      const token = localStorage.getItem('adminToken');
      const subject = document.getElementById('subjectForOutputs').value.trim();
      let outputsText = document.getElementById('outputsInput').value;
      if (!subject) {
        document.getElementById('dashboardMessage').textContent = "Please enter a subject name for outputs.";
        document.getElementById('dashboardMessage').className = "error";
        return;
      }
      try {
        const outputs = JSON.parse(outputsText);
        const res = await fetch(API_URL + '/api/admin/outputs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ subject, outputs })
        });
        const result = await res.json();
        document.getElementById('dashboardMessage').textContent = result.success ? "Outputs updated successfully" : "Error: " + result.error;
        document.getElementById('dashboardMessage').className = result.success ? "message" : "error";
      } catch (e) {
        document.getElementById('dashboardMessage').textContent = "Invalid JSON for outputs";
        document.getElementById('dashboardMessage').className = "error";
      }
    });

    // On page load, check if admin is registered and/or logged in.
    checkAdminRegistration();
  </script>
</body>
</html>
